@page "/notes/new"
@page "/notes/{id:guid}/edit"
@using System.ComponentModel.DataAnnotations
@using AINotesApp.Features.Notes.CreateNote
@using AINotesApp.Features.Notes.GetNoteDetails
@using AINotesApp.Features.Notes.UpdateNote
@using MediatR
@attribute [Authorize]

@inject IMediator Mediator
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(IsEditMode ? "Edit Note" : "Create Note")</PageTitle>

<div class="container mt-4">
   <div class="row">
	   <div class="col-lg-8">
		   <div class="d-flex justify-content-between align-items-center mb-4">
			   <h1>@(IsEditMode ? "Edit Note" : "Create New Note")</h1>
			   <a href="/notes" class="btn btn-outline-secondary">
				   <i class="bi bi-arrow-left"></i> Back to Notes
			   </a>
		   </div>

		   @if (!string.IsNullOrEmpty(_errorMessage))
		   {
			   <div class="alert alert-danger alert-dismissible fade show" role="alert">
				   <i class="bi bi-exclamation-triangle"></i> @_errorMessage
				   <button type="button" class="btn-close" @onclick="() => _errorMessage = null"></button>
			   </div>
		   }

		   @if (!string.IsNullOrEmpty(_successMessage))
		   {
			   <div class="alert alert-success alert-dismissible fade show" role="alert">
				   <i class="bi bi-check-circle"></i> @_successMessage
				   <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
			   </div>
		   }

		   @if (_isLoading)
		   {
			   <div class="text-center py-5">
				   <div class="spinner-border text-primary" role="status">
					   <span class="visually-hidden">Loading...</span>
				   </div>
				   <p class="mt-2">Loading note...</p>
			   </div>
		   }
		   else
		   {
			   <EditForm Model="@Model" OnValidSubmit="HandleSubmitAsync" FormName="noteEditor">
				   <DataAnnotationsValidator/>
				   <ValidationSummary class="alert alert-danger"/>

				   <div class="mb-3">
					   <label for="title" class="form-label">Title</label>
					   <InputText id="title" class="form-control" @bind-Value="Model!.Title" placeholder="Enter note title"
											 maxlength="200"/>
					   <ValidationMessage For="@(() => Model.Title)"/>
				   </div>

				   <div class="mb-3">
					   <label for="content" class="form-label">Content</label>
					   <InputTextArea id="content" class="form-control" @bind-Value="Model.Content" rows="15"
													placeholder="Write your note here..."/>
					   <ValidationMessage For="@(() => Model.Content)"/>
				   </div>

				   @if (!string.IsNullOrEmpty(_aiSummary))
				   {
					   <div class="alert alert-info" role="alert">
						   <strong><i class="bi bi-stars"></i> AI Summary:</strong>
						   <p class="mb-0 mt-2">@_aiSummary</p>
					   </div>
				   }

				   @if (!string.IsNullOrEmpty(_tags))
				   {
					   <div class="mb-3">
						   <strong><i class="bi bi-tags-fill"></i> Tags:</strong>
						   <div class="mt-2">
							   @foreach (var tag in _tags.Split(',', StringSplitOptions.RemoveEmptyEntries |
																								 StringSplitOptions.TrimEntries))
							   {
								   <span class="badge bg-primary me-1 mb-1">@tag</span>
							   }
						   </div>
					   </div>
				   }

				   <div class="d-flex justify-content-between align-items-center">
					   <button type="submit" class="btn btn-primary" disabled="@_isSaving">
						   @if (_isSaving)
						   {
							   <span class="spinner-border spinner-border-sm me-2" role="status"></span>
							   <span>Saving...</span>
						   }
						   else
						   {
							   <i class="bi bi-save me-2"></i>
							   <span>@(IsEditMode ? "Update Note" : "Create Note")</span>
						   }
					   </button>

					   @if (IsEditMode)
					   {
						   <div class="text-muted">
							   <small>
								   Created: @_createdAt.ToLocalTime().ToString("g")<br/>
								   Updated: @_updatedAt.ToLocalTime().ToString("g")
							   </small>
						   </div>
					   }
				   </div>
			   </EditForm>
		   }
		</div>

		<!-- Related Notes Sidebar (only in edit mode) -->
		@if (IsEditMode && Id.HasValue && !_isLoading)
		{
			<div class="col-lg-4">
				<div class="sticky-top" style="top: 20px;">
					<RelatedNotes NoteId="@Id.Value" UserSubject="@_userSubject" HasEmbedding="true" TopN="5"/>
				</div>
			</div>
		}
	</div>
</div>

@code {

	[Parameter] public Guid? Id { get; set; }


	[SupplyParameterFromForm] private NoteEditorModel? Model { get; set; }

	private bool _isLoading;

	private bool _isSaving;

	private string? _errorMessage;

	private string? _successMessage;

	private string _userSubject = string.Empty;

	private string? _aiSummary;

	private string? _tags;

	private DateTimeOffset _createdAt;

	private DateTimeOffset _updatedAt;

	private bool IsEditMode => Id.HasValue && Id.Value != Guid.Empty;

	protected override async Task OnInitializedAsync()
	{
		// Always ensure model is initialized
		if (Model == null)
		{
			Model = new NoteEditorModel();
		}
		try
		{
			var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
			var user = authState.User;

			if (user.Identity?.IsAuthenticated == true)
			{
				_userSubject = user.FindFirst("sub")?.Value ?? string.Empty;

				if (IsEditMode)
				{
					await LoadNoteAsync();
				}
			}
		}
		catch (Exception ex)
		{
			_errorMessage = $"Error initializing: {ex.Message}";
		}
	}

	private async Task LoadNoteAsync()
	{
		if (!Id.HasValue)
			return;

		try
		{
			_isLoading = true;
			_errorMessage = null;

			var query = new GetNoteDetailsQuery
			{
				Id = Id.Value,
				UserSubject = _userSubject
			};

			var response = await Mediator.Send(query);

			if (response == null)
			{
				_errorMessage = "Note not found or access denied.";

				return;
			}

			Model = new NoteEditorModel
			{
				Title = response.Title,
				Content = response.Content
			};

			_aiSummary = response.AiSummary;
			_tags = response.Tags;
			_createdAt = response.CreatedAt;
			_updatedAt = response.UpdatedAt;
		}
		catch (Exception ex)
		{
			_errorMessage = $"Error loading note: {ex.Message}";
		}
		finally
		{
			_isLoading = false;
		}
	}

	private async Task HandleSubmitAsync()
	{
		try
		{
			_isSaving = true;
			_errorMessage = null;
			_successMessage = null;

			if (IsEditMode)
			{
				await UpdateNoteAsync();
			}
			else
			{
				await CreateNoteAsync();
			}
		}
		catch (Exception ex)
		{
			_errorMessage = $"Error saving note: {ex.Message}";
		}
		finally
		{
			_isSaving = false;
		}
	}

	private async Task CreateNoteAsync()
	{
		var command = new CreateNoteCommand
		{
			Title = Model!.Title,
			Content = Model!.Content,
			UserSubject = _userSubject
		};

		var response = await Mediator.Send(command);

		_successMessage = "Note created successfully!";

		// Navigate to the edit page of the newly created note
		await Task.Delay(1000); // Brief delay to show success message
		Navigation.NavigateTo($"/notes/{response.Id}/edit");
	}

	private async Task UpdateNoteAsync()
	{
		if (!Id.HasValue)
			return;

		var command = new UpdateNoteCommand
		{
			Id = Id.Value,
			Title = Model!.Title,
			Content = Model!.Content,
			UserSubject = _userSubject
		};

		var response = await Mediator.Send(command);

		if (response.Success)
		{
			_successMessage = "Note updated successfully with AI summary and tags!";
			_aiSummary = response.AiSummary;
			_tags = response.Tags;
			_updatedAt = response.UpdatedAt;
		}
		else
		{
			_errorMessage = response.Message;
		}
	}

	private class NoteEditorModel
	{

		[Required(ErrorMessage = "Title is required")]
		[StringLength(200, ErrorMessage = "Title cannot exceed 200 characters")]
		public string Title { get; set; } = string.Empty;

		[Required(ErrorMessage = "Content is required")]
		public string Content { get; set; } = string.Empty;

	}

}