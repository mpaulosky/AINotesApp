@page "/notes"
@rendermode InteractiveServer
@using AINotesApp.Features.Notes.ListNotes
@using MediatR
@using Microsoft.AspNetCore.Authorization
@inject IMediator Mediator
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>My Notes</PageTitle>

<h1>My Notes</h1>

<div class="mb-3">
	<div class="row">
		<div class="col-md-4">
			<input type="text" class="form-control" placeholder="Search notes..." @bind="searchTerm" @bind:event="oninput" />
		</div>
		<div class="col-md-3">
			<select class="form-select" @bind="sortBy" @bind:after="LoadNotesAsync">
				<option value="UpdatedAt">Last Updated</option>
				<option value="CreatedAt">Date Created</option>
				<option value="Title">Title</option>
			</select>
		</div>
		<div class="col-md-2">
			<select class="form-select" @bind="sortDirection" @bind:after="LoadNotesAsync">
				<option value="desc">Descending</option>
				<option value="asc">Ascending</option>
			</select>
		</div>
		<div class="col-md-3 text-end">
			<button class="btn btn-primary" @onclick="CreateNewNote">
				<i class="bi bi-plus-circle"></i> Create New Note
			</button>
		</div>
	</div>
</div>

@if (isLoading)
{
	<div class="text-center">
		<div class="spinner-border" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
		<p class="mt-2">Loading notes...</p>
	</div>
}
else if (response == null || !response.Notes.Any())
{
	<div class="alert alert-info">
		<p class="mb-0">No notes found. Click "Create New Note" to get started!</p>
	</div>
}
else
{
	<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
		@foreach (var note in response.Notes)
		{
			<div class="col">
				<div class="card h-100">
					<div class="card-body">
						<h5 class="card-title">@note.Title</h5>
						@if (!string.IsNullOrWhiteSpace(note.Summary))
						{
							<p class="card-text text-muted">@note.Summary</p>
						}
						<p class="card-text">
							<small class="text-muted">
								Updated: @note.UpdatedAt.ToString("MMM dd, yyyy h:mm tt")
							</small>
						</p>
					</div>
					<div class="card-footer bg-transparent">
						<div class="d-flex gap-2">
							<button class="btn btn-sm btn-outline-primary flex-fill" @onclick="() => EditNote(note.Id)">
								<i class="bi bi-pencil"></i> Edit
							</button>
							<button class="btn btn-sm btn-outline-secondary flex-fill" @onclick="() => ViewNote(note.Id)">
								<i class="bi bi-eye"></i> View
							</button>
						</div>
					</div>
				</div>
			</div>
		}
	</div>

	@if (response.TotalPages > 1)
	{
		<nav aria-label="Notes pagination" class="mt-4">
			<ul class="pagination justify-content-center">
				<li class="page-item @(currentPage == 1 ? "disabled" : "")">
					<button class="page-link" @onclick="() => LoadPage(currentPage - 1)" disabled="@(currentPage == 1)">
						Previous
					</button>
				</li>

				@for (int i = 1; i <= response.TotalPages; i++)
				{
					var pageNumber = i;
					<li class="page-item @(currentPage == pageNumber ? "active" : "")">
						<button class="page-link" @onclick="() => LoadPage(pageNumber)">@pageNumber</button>
					</li>
				}

				<li class="page-item @(currentPage == response.TotalPages ? "disabled" : "")">
					<button class="page-link" @onclick="() => LoadPage(currentPage + 1)"
						disabled="@(currentPage == response.TotalPages)">
						Next
					</button>
				</li>
			</ul>
		</nav>
	}

	<div class="mt-3 text-muted text-center">
		<small>Showing @response.Notes.Count of @response.TotalCount notes</small>
	</div>
}

@code {
	[CascadingParameter]
	private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

	private ListNotesResponse? response;
	private string _searchTerm = string.Empty;
	private string searchTerm
	{
		get => _searchTerm;
		set
		{
			_searchTerm = value;
			OnSearchTermChanged();
		}
	}
	private string sortBy = "UpdatedAt";
	private string sortDirection = "desc";
	private int currentPage = 1;
	private const int PageSize = 9;
	private bool isLoading = true;
	private string userId = string.Empty;
	private System.Threading.Timer? searchDebounceTimer;

	protected override async Task OnInitializedAsync()
	{
		if (AuthenticationStateTask != null)
		{
			var authState = await AuthenticationStateTask;
			var user = authState.User;

			if (user.Identity?.IsAuthenticated == true)
			{
				userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
				await LoadNotesAsync();
			}
		}
	}

	private async Task LoadNotesAsync()
	{
		isLoading = true;

		var query = new ListNotesQuery
		{
			UserId = userId,
			PageNumber = currentPage,
			PageSize = PageSize,
			SearchTerm = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
			SortBy = sortBy,
			IsDescending = sortDirection == "desc"
		};

		response = await Mediator.Send(query);
		isLoading = false;
	}

	private async Task LoadPage(int pageNumber)
	{
		currentPage = pageNumber;
		await LoadNotesAsync();
	}

	private void CreateNewNote()
	{
		Navigation.NavigateTo("/notes/new");
	}

	private void EditNote(Guid noteId)
	{
		Navigation.NavigateTo($"/notes/edit/{noteId}");
	}

	private void ViewNote(Guid noteId)
	{
		Navigation.NavigateTo($"/notes/{noteId}");
	}

	protected override void OnInitialized()
	{
		// Debounce search input
		searchDebounceTimer = new System.Threading.Timer(async _ =>
		{
			await InvokeAsync(async () =>
	{
			currentPage = 1; // Reset to first page on search
			await LoadNotesAsync();
			StateHasChanged();
		});
		}, null, System.Threading.Timeout.Infinite, System.Threading.Timeout.Infinite);
	}

	private void OnSearchTermChanged()
	{
		searchDebounceTimer?.Change(500, System.Threading.Timeout.Infinite);
	}

	public void Dispose()
	{
		searchDebounceTimer?.Dispose();
	}
}